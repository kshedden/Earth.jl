```@meta
EditURL = "README.jl"
```

````julia
using Earth, Plots, StableRNGs, LaTeXStrings, Statistics, Printf
````

# Earth/MARS

This is a Julia implementation of a regression modeling procedure that
is similar to Jerome Friedman's 1991 Multivariate Adaptive Regression
Splines (MARS), which is also known as Earth for trademark reasons.

The forward (basis-construction) phase used here should be identical
to the original MARS procedure.  The original MARS used backward
selection for model pruning, but this implementation uses the Lasso,
which was not invented yet at the time that MARS was conceived.

## Usage

The following example has three explanatory variables with an additive
mean structure.  The additive contribution of x1 is quadratic, the
additive contribution of x2 is linear, and x3 does not contribute
to the mean structure.

````julia
rng = StableRNG(123)
n = 500
X = randn(rng, n, 3)
Ey = X[:, 1].^2 - X[:, 2]
y = Ey + randn(rng, n)
````

````
500-element Vector{Float64}:
  0.03861632477928345
 -1.330679547519288
  1.6649142972879953
  2.533445562406808
 -0.06635910712036441
  1.7234716133121857
  2.439339060312209
 -0.10528917878414984
  1.6625108841504868
  2.4856528345101307
  4.005722791797314
  0.5433138277077261
  0.46120707782029635
  0.6523859738523976
  2.552895459732106
  4.158738458626371
  1.9827006940846834
 -2.8027708373543962
  0.4628937009965113
  2.433663737217861
 -0.21844037191924248
  2.238452606582456
  2.485284945153811
  0.19902348726611757
  0.12844402725494058
  0.6657428209023659
  0.41969040679530534
  0.5269241792629149
  0.8969224179803853
 -0.6589270437383713
 -0.9069655390497083
  0.1956996183732705
 -0.2975972182965908
 -0.5622474896650457
  5.707138475902211
  2.599443557390012
  6.773761343239384
  2.359360179227245
 -0.09596337895611451
  3.3249169953613764
  3.4420618906339167
 -0.475815432189356
  0.2650239545083264
  0.14857893952932621
  0.5256846071395105
  0.36572318486009725
 -0.1807610726403267
  1.811498963012855
  8.738528100202592
  5.07803883763045
  3.175207870420259
 -1.0981840588137222
  2.8843953125793127
 -0.01655304631012733
 -0.3401273508902598
  0.6799338609915339
  3.8341002948333847
  1.64593989968058
  1.388304191603004
  0.5619826292687333
 -1.1870975529774461
 -0.598334827097174
  0.3732932467525942
 -1.9335365876501354
  1.542043070684755
  1.5980279662204895
 -0.3374505330074725
  2.995535961560809
 -0.43463895403000596
  0.5968961120994136
  1.9900101636182952
  0.13394119814443445
 -0.45997302174252797
 -1.773626275987894
  0.785035516170299
  0.6763959884561656
  4.133798508212522
 -1.5604365656889903
  0.9522933917651517
 -0.9779511923213151
 -2.5308001967153047
  3.7132124565017346
  0.3728065672134322
  1.1169531279025726
  5.69242237908629
  3.7921524641208357
 -1.4112696447385829
  0.7004165194902949
  1.4430432618347366
  1.0386502497044867
  2.1994052976018543
  1.69186778275688
  2.946636354464434
  0.7159880637585473
  3.637434928808168
  2.5121446486463332
  6.588762510595702
  0.8242012738163136
 -0.7458648915667337
  1.3474335104805568
  1.3363364498147519
 -1.96774172728799
  5.3655402280361555
  0.0035667425294912958
  2.1439423488292273
  3.234513772195373
 -0.7604781517921686
  1.1615178841519143
  5.6088841149728434
 -0.8756352202521687
  3.2745855631979506
  1.0150254703045933
 -1.1563499271867774
 -1.398920177048941
 -0.8160825894242381
  4.5076485956553025
 -0.22479328587534164
 -1.9823753157649988
  0.14588741941243755
  0.036733247900609944
  2.555141212129946
 -0.7426847619409811
  0.33756402061148805
  0.27527556971431266
 -0.6088180904786239
  1.9363920751062156
  0.7500354904908296
  1.817270047940993
  3.4787800615043523
  2.900586784887343
  1.8921236891331645
  1.6925611942197212
  1.6870334510122622
  3.727413585252484
  1.5962717206121169
  3.3284227315314796
 -0.29918335441515675
  5.505862288539276
  0.7562935333114114
 -1.4726378752529687
  1.2421250749131763
  0.1676450223573004
  0.3799312073362019
 -1.1836976360358595
  0.19530544826137575
  2.9400029221478206
  0.707715019961719
  1.2676930078055806
 -0.974103734453299
  5.7870792376396
  0.5583147138008703
  1.4839679629710503
  1.1841710739989781
 -1.1053537902369501
  1.0028776074629135
  2.128604304048911
  2.8381188789942495
 -1.6400385895810343
 -0.33172991945874436
  4.345785429478614
 -0.13770376162288459
  0.6608400008513542
  3.908968202744749
  1.5712681634892218
  0.4081663284723227
  1.7803174056625721
  1.086824646527503
 -0.435343957204793
 -1.2807284928404337
 -1.5810504593723413
 -0.6943905689664314
  0.11471791482772542
 -2.056160000973765
  1.3750969626221439
 -0.7542379395857369
  0.19855104059505196
 -2.7711700471168648
  1.9139640763964838
  2.3125610072290588
  1.0737886728117236
 -0.4312053131244956
 -2.0031976763357577
  1.6204551832245955
 -1.699224118667313
  3.586481760954782
  0.3589307098258478
  0.46333307535427115
  1.341587139289397
  0.46639076687985326
 -2.765077948711542
 12.119374001226552
 -0.7473369207800131
 -1.6918808519627264
  2.345422374508156
 -0.646690218962916
  1.422601337898181
  0.3752110322522424
  0.9284927627844295
  2.053377077666368
  0.5919458619487006
 -1.7080875311158332
  2.033262409283853
  0.5888236151355285
  1.2119451235756182
  3.471029578623887
  0.7058713117639829
  1.8390230507118703
  1.7571549955090857
  1.0896358134983468
  0.6931103917883789
  1.8877799486863887
 -1.501482351066569
  0.032993236922888386
 -0.3128573616637277
  1.7043242419644222
  1.2377943589917195
 -1.5022322529763028
  2.187144148245419
  0.44878918472681184
  3.437212564229247
 -1.5677279809049152
 -2.1129793543043958
  4.29813687458538
 -0.49763936105786744
  0.43533193218522326
  3.4948384357485587
 -1.539505521822628
  0.8519439849668736
  2.788910332074007
  0.7508190271960231
  0.8507459131891031
 -1.83237190945766
  1.9194091120846724
 -1.215556017646147
  1.9946537995574216
 -0.13306234929084182
  2.986829825857741
 -0.8450704425654587
  0.6310892303643347
  1.2217887918049302
  0.38983433926126054
  3.1124313917845416
 -0.6194534380202978
 -1.5332897275101862
 -0.3854616922828261
  1.6430989871428838
  3.459808977520707
  0.017461198707645634
  1.2420876087680393
  2.4626089022183995
 -0.7715758035434357
 -0.447759205729208
  2.3383120015650136
  1.0195716243861888
  2.922934238364322
 -0.01140400422479071
  0.15491721741210718
  2.3574219960216847
  0.48003170700492825
 -0.8431356289216213
  1.3817159391831617
  1.8426108431910704
  1.962067235287067
  0.23004892537567953
 -0.3772765566838089
 -0.3270923186246161
  2.036176328925616
  1.5102790252350293
  2.032438332996794
  3.4923741983949004
  3.06497750360006
  1.6743922676425156
  0.2262003466426692
  1.7567783611091425
 -1.1035531055893917
  1.7154313826048169
  0.2533911855764463
 -1.1386454663873768
  0.964990257968024
  1.4148138613565253
  0.044734131532010224
  0.8498609701396636
  2.140529681261283
  3.76786679850608
 -1.1124005156180177
  0.4627641554197247
  5.916710834589263
  1.1140318879407818
  1.8055048737935753
  1.2583108308047022
  1.1047505079329347
 -0.6797290740135459
  6.250256728118419
 -1.1074727705239373
  1.5475072197426978
 -2.851434386309402
  0.04826659304763736
 -0.7550437079550301
  2.1610767747445636
  0.9154199514475817
  7.906673172388983
  1.234944306798278
  3.9975117273569203
  1.579590966962914
  0.2750852689383059
  0.5111875970490701
  3.198245047366412
  0.01996329593315886
  3.901132075797655
 -1.1515886003407658
  0.17788221001415724
  1.9121102891441313
  1.6246869988802057
  1.5288039656193102
  4.333285732056061
 -0.01854910077343974
 -1.4142042567140776
  4.966378208633271
  2.369842322228936
  1.048633316669683
  0.8316852584797144
 -1.4083355965348847
 -0.67530201140764
  0.12522693096946574
 -0.18582775859150324
 -0.7548715954898928
  3.0625232235917137
  1.6346156754877263
 -0.7097551607358844
  1.406820946413588
 -0.11807393864515067
  1.2963018138696767
  3.7050108230960257
  2.08793039163662
  0.39111551775937037
  1.150153423193692
 -1.5048350868749958
 -0.4045151026403703
 -0.479603410956838
  0.06169749594596596
  1.274062323753255
  0.8973357295032464
 -1.030384373609494
  2.350166945304622
 -0.10661234392873414
 -1.1106376424838778
 -0.9856459059704746
  3.9720884580359765
  0.9705696388543282
  0.47596621552798124
  0.8494212901138852
 -0.4011065296104954
  3.014084946998384
 -0.12846378596543617
  0.455136835611335
  1.109547695859424
 -0.42403544941856675
  1.2449731592764743
 -0.09132432968265158
  1.3496972751384464
  2.0605887801374223
  0.9195829478056321
 -1.0100019889587535
  2.0630968307679733
  2.3004291385983304
  0.6214059849242543
 -0.8270083662320948
  3.3661417780443434
  1.4243735801140862
 -2.2459065562602962
  1.715177452358148
  0.45668120512172294
 -1.7623583232053714
 -0.23114977036452378
  5.826903449449819
 -1.508212805602077
 -2.3553227316676284
  1.375414544013241
  0.02665555314837731
 -0.4847731087021843
  2.211762766714488
 -0.16862304546538376
 -0.7833536389038649
 -0.863496852251499
 -1.1846972398899642
  2.874456652695475
  0.013341601888823884
  2.5641658962166494
  3.006619812993598
  2.573545265066061
  1.2523771847422411
 -0.46617429707787317
 -0.07706243914937971
  2.1839263671153413
  2.9373519913410853
  1.6121124071090174
  4.114727973758582
  3.8722099605484637
  1.3749348584105454
  2.996640108295141
 -1.2478636579276672
  0.9212568241054566
 -2.5330735884677336
  1.6626484523158296
  0.5877663230813917
 -0.7046465424874446
  1.5390560263642474
 -2.8813655286603153
 -0.8719309678485658
  0.03528757809304861
 -0.3275214412639759
  5.718124277529764
  1.5289533931255173
  1.781218440370089
 -1.9574589648155523
  0.07489558395653073
  1.4753269288109003
  4.293562807767986
  2.1637528900785363
  2.4098091801415835
  1.5805516765529253
  3.337975281606549
 -1.9012492362555355
 -0.814057205110379
  3.2258170043596337
  2.5866299617733297
  0.28343730384992916
  0.40401706936799864
  0.580688960979088
  0.7326261684117135
  1.2207905863438409
  0.27124917361123807
 -1.187111893804848
  1.7807556903020096
 -1.1577858967024717
 -2.6195788583815656
 -0.06433344462636503
  2.210139229786275
  0.2769262579280263
  2.9248342972798405
 -0.07633422176454174
  1.5864276418826888
  0.2688260784278453
  1.5082058181651194
 -0.8806762801606538
  0.8544172640927281
 -0.1172572139804261
  3.5922179783356176
  0.42941053426327236
  5.795288217448206
  1.6869205077794658
  1.3231891450546722
 -0.27842420699527515
 -0.5479791006616739
 -0.8766151584893886
 -2.946914986866669
  1.7454682737306397
  2.3219949934473996
  0.3400415244607407
 -1.265331111980034
  3.7225734077893997
  1.5749787454253643
  0.24226149035890465
  0.8524225144851209
  5.827134460008435
  0.3944584218554495
  2.1943246724883636
  0.314133011052365
  2.1288156256640463
  1.4383458064454846
  0.5692256777285776
  2.2789797478007388
  0.08670479445971202
  1.287823131237424
  0.6057841365826852
  1.8242138936118169
  6.975698590519054
  0.7014745006567056
 -0.5353652893887743
 -1.566140258182088
  3.2911303429067127
 -0.7309979775049946
 -0.46127518268936135
  2.4413661440827665
  1.1292000626445189
  1.3783649237827817
  1.157946031503258
 -1.4102535401068494
  2.064743543089263
  0.46154770488010566
 -0.5451591949751335
  4.301561448340166
  3.865542053391667
  2.4769053182592846
 -0.036136076641153925
  3.4805206775555164
  0.13800621544870684
  4.186035976840017
  1.855879558578337
  0.5526605028334899
````

There are several ways to control the structure of the model
fit by Earth.  First we set `maxorder=1`, which produces an
additive fit, meaning that each term in the fitted mean
structure involves only one of the original variables.  By
default, the maximum "degree" of the fitted model is two,
meaning that each term can include up to two hinges involving
the same variable.  The constraints `maxorder=1` and `maxdegree=2`
allow Earth to exactly represent the true mean structure in this
example.

````julia
md1 = fit(EarthModel, X, y; maxorder=1)
````

````
     2.043  intercept
     0.328  intercept * h(0.254 - v1)
     0.616  intercept * h(0.091 - v2)
     2.203  intercept * h(-1.164 - v1)
     0.934  intercept * h(v1 - -1.164) * h(v1 - -0.141)
    -0.181  intercept * h(-1.066 - v3)
    16.582  intercept * h(v3 - -1.066) * h(-0.695 - v3)
   -11.711  intercept * h(-1.164 - v1) * h(v1 - -1.566)
     0.765  intercept * h(-1.164 - v1) * h(-1.566 - v1)
    -0.944  intercept * h(v1 - -1.566)
    -0.611  intercept * h(v2 - -1.645)
    -0.046  intercept * h(v2 - -1.645) * h(v2 - -1.029)
    -5.066  intercept * h(v2 - -1.645) * h(-1.029 - v2)

````

To visualize how well we have fit the mean structure, we can consider
the fitted conditional mean of Y as a function of x1, holding
x2 fixed at zero.  The true value of this function is $Ey = x_1^2$.

````julia
x = -2:0.2:2
X1 = [x zeros(length(x)) zeros(length(x))]
y1 = predict(md1, X1)

p = plot(x, y1, xlabel=L"$x_1$", ylabel=L"$y$", label=L"$E[y | x_1, x_2=0]$",
         size=(400, 300))
p = plot!(p, x, x.^2, label=L"$y = x_1^2$")
Plots.savefig(p, "../assets/readme1.svg")
````

````
"/home/kshedden/Projects/julia/Earth/assets/readme1.svg"
````

![Example plot 1](assets/readme1.svg)

We can also consider the fitted conditional mean of y as a function
of x2, holding x1 fixed at zero.  The true value of this function
is $Ey = -x_2$.

````julia
x = -2:0.2:2
X2 = [zeros(length(x)) x zeros(length(x))]
y2 = predict(md1, X2)

p = plot(x, y2, label=L"$E[y | x_1=0, x_2]$", xlabel=L"$x_2$", ylabel=L"$y$",
         size=(400, 300))
p = plot!(p, x, -x, label=L"$y = -x_2$")
Plots.savefig(p, "../assets/readme2.svg")
````

````
"/home/kshedden/Projects/julia/Earth/assets/readme2.svg"
````

![Example plot 1](assets/readme2.svg)

Next we refit the model using Earth, but allowing up to two-way
interactions (even though no two-way interactions are present.

````julia
md2 = fit(EarthModel, X, y; maxorder=2, maxdegree=2)

x = -2:0.2:2
X1 = [x zeros(length(x)) zeros(length(x))]
y1 = predict(md2, X1)
p = plot(x, y1, xlabel=L"$x_1$", ylabel=L"$y$", label=L"$E[y | x_1, x_2=0]$",
         size=(400, 300))
p = plot!(p, x, x.^2, label=L"$y = x_1^2$")
Plots.savefig(p, "../assets/readme3.svg")
````

````
"/home/kshedden/Projects/julia/Earth/assets/readme3.svg"
````

![Example plot 3](assets/readme3.svg)

Now we specify a different population structure that is
not additive. The standard deviation of the residuals
is very close to the standard deviation of the errors,
which is 1.

````julia
rng = StableRNG(123)
n = 1000
X = randn(rng, n, 3)
Ey = X[:, 1].^2 + X[:, 1] .* X[:, 2]
y = Ey  + randn(rng, n)

md3 = fit(EarthModel, X, y)
````

````
    -0.055  intercept
    -0.829  intercept * h(0.039 - v1)
     0.990  intercept * h(v1 - 0.039) * h(v2 - -0.794)
    -1.011  intercept * h(v1 - 0.039) * h(-0.794 - v2)
    -0.816  intercept * h(0.039 - v1) * h(v2 - 1.195)
     0.991  intercept * h(0.039 - v1) * h(1.195 - v2)
    21.626  intercept * h(0.039 - v1) * h(v1 - -0.342)
     0.970  intercept * h(0.039 - v1) * h(-0.342 - v1)
     0.751  intercept * h(v1 - 0.039) * h(v1 - 0.448)
   -12.025  intercept * h(v1 - 0.039) * h(0.448 - v1)
  -148.188  intercept * h(0.039 - v1) * h(v1 - -0.342) * h(v3 - 1.705)
    -8.787  intercept * h(0.039 - v1) * h(v1 - -0.342) * h(1.705 - v3)
    25.632  intercept * h(v1 - 0.039) * h(v2 - -0.794) * h(0.301 - v1)
     0.085  intercept * h(v1 - 0.039) * h(v1 - 0.448) * h(v3 - -1.267)
    -0.647  intercept * h(v1 - 0.039) * h(v1 - 0.448) * h(-1.267 - v3)
    -3.490  intercept * h(0.039 - v1) * h(v1 - -0.342) * h(v2 - -0.487)
   -16.530  intercept * h(0.039 - v1) * h(v1 - -0.342) * h(-0.487 - v2)
 13831.105  intercept * h(0.039 - v1) * h(v1 - -0.342) * h(v2 - -0.487) * h(-0.347 - v2)

````

One way to assess how well we have fit the mean structure is
by considering the mean squared error (MSE). If we have closely
captured the mean structure, then the MSE should be close to the
residual variance, which is 1.

````julia
res = residuals(md3)
mean(res.^2)
````

````
0.9225805004783731
````

Below we plot three conditional mean functions of the form
E[y | x_1, x_2=f] for fixed values of f (0, 1, and 2).

````julia
function make_plot(md)
    x = -2:0.2:2
    p = nothing
    yy = []
    cols = ["orange", "purple", "lime"]
    for (j,f) in enumerate([0, 1, 2])
        X1 = [x f*ones(length(x)) zeros(length(x))]
        yp = predict(md, X1)
        p = if j == 1
            plot(x, x.^2 + f*x, xlabel=L"$x$", ylabel=L"$y$", label=L"$E[y | x_1, x_2=%$f]$",
                 color=cols[j], size=(400, 300))
        else
            plot!(p, x, x.^2 + f*x, color=cols[j], label=L"$E[y | x_1, x_2=%$f]$")
        end
        plot!(p, x, yp, color=cols[j], label=L"$\hat{E}[y | x_1, x_2=%$f]$")
    end
    Plots.savefig(p, "../assets/readme4.svg")
end

make_plot(md3)
````

````
"/home/kshedden/Projects/julia/Earth/assets/readme4.svg"
````

![Example plot 4](assets/readme4.svg)

Below we plot the generalized r-squared statistic against the number of
model terms (the degrees of freedom in the model) during the forward
phase of model construction.  The true (population) r-squared value is
also plotted.

````julia
p = plot(md3.nterms, gr2(md3), label=L"Estimated $r^2$", size=(400, 300),
         xlabel="Number of terms", ylabel=L"$r^2$")
p = plot!(p, md3.nterms, cor(Ey, y)^2*ones(length(md3.nterms)), label=L"True $r^2$")
Plots.savefig(p, "../assets/readme5.svg")
````

````
"/home/kshedden/Projects/julia/Earth/assets/readme5.svg"
````

![Example plot 5](assets/readme5.svg)

## References

[1] Multivariate Adaptive Regression Splines, Jerome H. Friedman.
The Annals of Statistics, Vol. 19, No. 1. (Mar., 1991), pp. 1-67.

---

*This page was generated using [Literate.jl](https://github.com/fredrikekre/Literate.jl).*

